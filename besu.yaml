version: "3.8"
services:

  jbc-execution:
    container_name: jbc-execution
    image: hyperledger/besu:latest
    user: root
    command:
      - --genesis-file=/genesis.json
      - --data-path=/datadir
      - --rpc-ws-enabled
      - --rpc-http-enabled
      - --engine-jwt-secret=/config/jwt.hex
      - --p2p-host=${NODE_PUBLIC_IP}
      - --host-allowlist=*
      - --nat-method=DOCKER
      - --bootnodes=enode://f06e9a7b61376bcd95df21cd6f624c46c62c8fe5b18faa96d85542bb08aa3af0c0726291cab36f30917e34ab35e0ba064ac811f5c4ac7e836d2ce95447975d5e@135.181.4.243:32323,enode://af679fdd2c099223a3a7eb361c45467bbd8f38bbceccb10775ae2a41c933c9edfd751f0df52faab356644c9ce7fe7cdfd091b9570da1384d16468901d6128c28@88.198.230.131:32323,enode://d72f4e721c183842339728da3ee63d4406bed2ce61bb053d613ccf3ccbae1fffaedeb3285675d0889577e0d284e61d1b240897c7bedadaf188bb7cdd89a55aa3@65.21.192.220:32323,enode://5519975ec8e34998d7d0a043facb1b355e3cad7f1ce7e9ba8e7527ef1d42be2a851382b7f2b8803391ea6b7c8e39f8921ce58452a540cc26c5d21861489629c8@65.21.194.198:32323,enode://78afa4dcdaac345d66fc13c1962ac2f16d1ea6769022a882cb0eda66e32c2887698ea1215d453764545e73e68559cc2fd1e9f202b18262a0d602267f04d5f261@95.217.58.14:32323,enode://a8f25666194c5d56516168040322f8a8a5dd501fff549845f8fce06f64f8553feec6fbacb70aa4e85f7a9361351e454e8498c817a227a854b9104a8dcb4c8ee7@94.130.222.145:32323,enode://b22a53a06bde223260ab9b0547fbe762ae4e22a15045df2302a5d4d804fd91889a235098c774afd0cde9ebdde9ff9cc88f9e4a0ccbf792fe6a76665eef66f028@195.201.105.166:32323,enode://fb6d8e33fa16949995c5f20479948bda9ede515334331da39e8e099053f563ac3472eddd29ecbe34a5088af0dec09b034617ad74181179084fbdf80fb37c323a@65.108.75.252:32323,enode://a94483cecbcd07fa8b1610af4b10586c650665679544a77bf57d0b6abfc5f6aec335a6e0e2cab4235599707cac3496f6d28b08806a169539a53021485aaf792c@65.108.120.116:32323,enode://0cb1d60e40aa5dcd83a91f7c4aab4e8c53fcbe64b6a0127b6b30ce54838c1f68b46d60a344d88fdb4335eace67343ed04a8a60d2ebe7f8a5c4d5534366c5d29c@65.108.195.126:32323,enode://5d8e4f7d49b3ccd6a1482afe8475300b80f6283352b1c8f3f55c7098c92c6f84bc19a6e97748676921785d5672b7023ae9896908c47a519424035159e6ed8077@65.108.201.210:32323,enode://e674c17f9fbad5d5b8776fd9aab48d958b972f48b28c3d2ae0cb3e238f058cafc1d4996b0936bbe26dbfb4b94f80bc80ad425d5d37ca2fe2d241c60ca0bcaf50@135.181.62.40:32323,enode://d370724b1ceff14ef55a23098b21b4182a6b9743d48ee3cee539d662b051ff0452a27aaef7f43da8312f66f9c3cbd3201420b6145bbfe1544b4cd99b412d798a@95.217.122.150:32323
    volumes:
      - ./genesis.json:/genesis.json
      - ./data:/datadir
      - ./config:/config
    ports:
      - 30303:30303
      - 8545:8545
    restart: always

  jbc-consensus:
    container_name: jbc-consensus
    image: sigp/lighthouse:v5.0.0
    user: root
    entrypoint: /root/lighthouse-script.sh
    command:
      - lighthouse
      - beacon
      - --execution-endpoint=http://jbc-execution:8551
      - --execution-jwt=/config/jwt.hex
      - --testnet-dir=/config
      - --http-allow-sync-stalled
      - --disable-peer-scoring
      - --http
      - --http-address=0.0.0.0
      - --http-port=5002
      - --disable-packet-filter
      - --eth1
      - --target-peers=${TARGET_PEERS}
      - --enr-address=${NODE_PUBLIC_IP}
      - --enr-udp-port=9100
      - --enr-tcp-port=9100
      - --port=9100
      - --checkpoint-sync-url=https://metrabyte-cl.jibchain.net/
      - --prune-blobs=false
    volumes:
      - ./data/lighthouse:/root/.lighthouse
      - ./config:/config
      - ./lighthouse-script.sh:/root/lighthouse-script.sh
    ports:
      - 0.0.0.0:9100:9100/tcp
      - 0.0.0.0:9100:9100/udp
      - 0.0.0.0:5002:5002/tcp
      - 0.0.0.0:5002:5002/udp
