services:
  jbc-init:
    user: root
    image: erigontech/erigon:latest
    command: >
      --datadir /data/erigon
      init /config/genesis.json
    volumes:
      - ./data:/data
      - ./config:/config

  jbc-execution:
    container_name: jbc-execution
    restart: unless-stopped
    image: erigontech/erigon:latest
    depends_on:
       - jbc-init
    user: root
    command: >
      --datadir /data/erigon
      --authrpc.addr 0.0.0.0
      --authrpc.port 8551
      --authrpc.jwtsecret /config/jwt.hex
      --db.size.limit 8TB
      --db.pagesize 16kb
      --networkid 8899
      --externalcl
      --bootnodes "enode://822ae5e5ce3137f068345b11aa656fe53b4fad544328f249b875918500e01d5291d22f0f0668ca8e2e549fa042797a2e3bde66703d973666c4d385a7eb5a4025@188.34.178.225:30303"
      --staticpeers "enode://822ae5e5ce3137f068345b11aa656fe53b4fad544328f249b875918500e01d5291d22f0f0668ca8e2e549fa042797a2e3bde66703d973666c4d385a7eb5a4025@188.34.178.225:30303"
      --http.addr="0.0.0.0"
      --http.api=eth,web3,net,debug,trace,txpool,ots

    volumes:
      - ./data:/data
      - ./config:/config
    ports:
      - 30303:30303
      - 8545:8545

  jbc-consensus:
    container_name: jbc-consensus
    image: sigp/lighthouse:latest
    user: root
    entrypoint: /root/lighthouse-script.sh
    command:
      - lighthouse
      - beacon
      - --execution-endpoint=http://jbc-execution:8551
      - --execution-jwt=/config/jwt.hex
      - --testnet-dir=/config
      - --http
      - --http-address=0.0.0.0
      - --http-port=5002
      - --target-peers=${TARGET_PEERS}
      - --enr-address=${NODE_PUBLIC_IP}
      - --enr-udp-port=9100
      - --enr-tcp-port=9100
      - --port=9100
      - --checkpoint-sync-url=https://metrabyte-cl.jibchain.net/
      - --prune-blobs=false
    volumes:
      - ./data/lighthouse:/root/.lighthouse
      - ./config:/config
      - ./lighthouse-script.sh:/root/lighthouse-script.sh
    ports:
      - 0.0.0.0:9100:9100/tcp
      - 0.0.0.0:9100:9100/udp
      - 0.0.0.0:5002:5002/tcp
      - 0.0.0.0:5002:5002/udp
